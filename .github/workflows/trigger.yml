name: Trigger

on:
  schedule:
    - cron: '0 0 * * *'  # daily check
  workflow_dispatch:     # manual trigger

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      trigger: ${{ steps.set-output.outputs.trigger }}
    steps:
      - name: Checkout vcpkg-json repo
        uses: actions/checkout@v4
        with:
          repository: maxtek6/WebFrame
          path: WebFrame

      - name: Compute hash of vcpkg.json
        id: hash
        run: |
          HASH=$(sha256sum WebFrame/vcpkg.json | awk '{print $1}')
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Get latest vcpkg release
        id: release
        run: |
          LATEST=$(curl -s https://api.github.com/repos/microsoft/vcpkg/releases/latest | jq -r '.tag_name')
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Restore cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .cache
          key: vcpkg-trigger-cache

      - name: Determine if trigger is needed
        id: set-output
        run: |
          LAST_HASH=$(cat .cache/last_hash.txt || echo "")
          LAST_RELEASE=$(cat .cache/last_release.txt || echo "")
          echo "LAST_HASH=$LAST_HASH"
          echo "LAST_RELEASE=$LAST_RELEASE"
          if [[ "$LAST_HASH" == "${{ steps.hash.outputs.hash }}" && "$LAST_RELEASE" == "${{ steps.release.outputs.latest }}" ]]; then
            echo "No changes, skip processing pipeline"
            echo "trigger=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            mkdir -p .cache
            echo "${{ steps.hash.outputs.hash }}" > .cache/last_hash.txt
            echo "${{ steps.release.outputs.latest }}" > .cache/last_release.txt
            echo "trigger=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload cache
        uses: actions/cache@v4
        with:
          path: .cache
          key: vcpkg-trigger-cache